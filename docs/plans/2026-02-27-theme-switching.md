# Theme Switching Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Enable switching between Hyprland themes (colors + wallpaper) via a `theme-switch` CLI command, backed by Nix flake configuration generation and Stylix.

**Architecture:** A central theme registry (`themes.nix`) maps theme names to `{scheme, wallpaper}` pairs. The flake generates home-manager configs for every host x theme combination. A `theme-switch` shell script runs `nh home switch` targeting the right config.

**Tech Stack:** Nix flakes, home-manager, Stylix, base16-schemes, writeShellApplication

---

### Task 1: Create the Hyprland Default Base16 Theme

**Files:**

- Create: `modules/stylix/assets/themes/hyprland_default.yaml`

**Step 1: Create the theme file**

Create `modules/stylix/assets/themes/hyprland_default.yaml` with these contents:

```yaml
scheme: "Hyprland Default"
author: "Derived from Hyprland autogenerated config"
# Colors from Hyprland's default config: cyan-to-green gradient on dark gray.
# Active border: rgba(33ccffee) rgba(00ff99ee) 45deg
# Inactive border: rgba(595959aa)
# Shadow: rgba(1a1a1aee)
base00: "111111" # default bg (dark charcoal)
base01: "1a1a1a" # secondary bg (shadow tone)
base02: "2a2a2a" # selection
base03: "595959" # comments/inactive (inactive border)
base04: "808080" # dark foreground
base05: "cccccc" # default foreground
base06: "e0e0e0" # light foreground
base07: "ffffff" # brightest foreground
base08: "ff5555" # red (errors)
base09: "ff9944" # orange (constants)
base0A: "ffee55" # yellow (classes)
base0B: "00ff99" # green (from default gradient)
base0C: "33ccff" # cyan (from default gradient)
base0D: "33aaff" # blue (functions/primary accent)
base0E: "cc77ff" # purple (keywords)
base0F: "ff77aa" # pink (deprecated)
```

**Step 2: Commit**

```bash
git add modules/stylix/assets/themes/hyprland_default.yaml
git commit -m "feat: add hyprland default base16 theme"
```

---

### Task 2: Create the Theme Registry

**Files:**

- Create: `themes.nix`

**Step 1: Create themes.nix**

Create `themes.nix` at the repo root:

```nix
{ pkgs }:
{
  final-fantasy = {
    scheme = ./modules/stylix/assets/themes/final_fantasy.yaml;
    wallpaper = ./modules/stylix/assets/walls/FF.png;
  };
  grail = {
    scheme = ./modules/stylix/assets/themes/grail.yaml;
    wallpaper = ./modules/stylix/assets/walls/Tiberius.png;
  };
  dark-oxide = {
    scheme = ./modules/stylix/assets/themes/dark_oxide.yaml;
    wallpaper = ./modules/stylix/assets/walls/Igris.png;
  };
  catppuccin-mocha = {
    scheme = "${pkgs.base16-schemes}/share/themes/catppuccin-mocha.yaml";
    wallpaper = ./modules/stylix/assets/walls/catppuccin-mocha.png;
  };
  tokyo-night = {
    scheme = "${pkgs.base16-schemes}/share/themes/tokyo-night-dark.yaml";
    wallpaper = ./modules/stylix/assets/walls/tokyo-night.png;
  };
  hyprland-default = {
    scheme = ./modules/stylix/assets/themes/hyprland_default.yaml;
    wallpaper = ./modules/stylix/assets/walls/hyprland-default.png;
  };
}
```

**Step 2: Commit**

```bash
git add themes.nix
git commit -m "feat: add theme registry"
```

---

### Task 3: Create the theme-switch Script

**Files:**

- Create: `home/tools/theme-switch` (shell script, no extension)
- Create: `home/tools/theme-switch.nix`

**Step 1: Create the shell script**

Create `home/tools/theme-switch`:

```bash
FLAKE_DIR="${HOME}/nix-config"
THEME="${1:-}"

# Available themes (injected at build time via sed replacement)
AVAILABLE_THEMES="@THEME_LIST@"

if [ -z "${THEME}" ]; then
  echo "Usage: theme-switch <theme-name>"
  echo ""
  echo "Available themes:"
  for t in ${AVAILABLE_THEMES}; do
    echo "  - ${t}"
  done
  exit 0
fi

# Validate theme name
VALID=false
for t in ${AVAILABLE_THEMES}; do
  if [ "${t}" = "${THEME}" ]; then
    VALID=true
    break
  fi
done

if [ "${VALID}" = "false" ]; then
  echo "Error: Unknown theme '${THEME}'"
  echo "Available themes:"
  for t in ${AVAILABLE_THEMES}; do
    echo "  - ${t}"
  done
  exit 1
fi

HOSTNAME="$(hostname)"
CONFIG="${USER}@${HOSTNAME}-${THEME}"

echo "Switching to theme: ${THEME}"
echo "Config: ${CONFIG}"
nh home switch "${FLAKE_DIR}" -c "${CONFIG}"
echo "Theme switched to: ${THEME}"
```

**Step 2: Create the nix module**

Create `home/tools/theme-switch.nix`:

```nix
{ pkgs, ... }:
let
  themes = import ../../themes.nix { inherit pkgs; };
  themeList = builtins.concatStringsSep " " (builtins.attrNames themes);

  theme-switch = pkgs.writeShellApplication {
    name = "theme-switch";

    runtimeInputs = with pkgs; [
      nh
      hostname
    ];

    text = builtins.replaceStrings
      [ "@THEME_LIST@" ]
      [ themeList ]
      (builtins.readFile ./theme-switch);
  };
in
{
  home.packages = [ theme-switch ];
}
```

**Step 3: Commit**

```bash
git add home/tools/theme-switch home/tools/theme-switch.nix
git commit -m "feat: add theme-switch CLI script"
```

---

### Task 4: Update home.nix to Import theme-switch

**Files:**

- Modify: `home/home.nix:3-7`

**Step 1: Add the import**

In `home/home.nix`, add `./tools/theme-switch.nix` to the imports list:

```nix
  imports = [
    ./tools/oath.nix
    ./tools/wf-recorder.nix
    ./tools/theme-switch.nix
    ../modules/hm
  ];
```

**Step 2: Commit**

```bash
git add home/home.nix
git commit -m "feat: import theme-switch module"
```

---

### Task 5: Refactor flake.nix homeConfigurations

**Files:**

- Modify: `flake.nix:151-177`

**Step 1: Replace the homeConfigurations block**

Replace lines 151-177 in `flake.nix` with the theme-aware generation:

```nix
      homeConfigurations =
        let
          themes = import ./themes.nix { inherit pkgs; };

          hostDefaults = {
            tiberius = "final-fantasy";
            atlas = "final-fantasy";
            lapnix = "final-fantasy";
            mantra = "final-fantasy";
          };

          mkHome =
            hostname: themeName:
            let
              theme = themes.${themeName};
            in
            home-manager.lib.homeManagerConfiguration {
              inherit pkgs;
              extraSpecialArgs = {
                inherit inputs user;
              };
              modules = [
                {
                  home.username = user.username;
                  home.stateVersion = "25.05";
                  home.homeDirectory = "/home/${user.username}";
                }
                ./home/home.nix
                ./hosts/${hostname}/home-overrides.nix
                stylix.homeModules.stylix
                {
                  modules.themes.theme = theme.scheme;
                  modules.themes.wallpaper = theme.wallpaper;
                  modules.hyprpaper.wallpaper = builtins.toString theme.wallpaper;
                }
              ];
            };

          # Generate all host x theme combinations
          allConfigs = builtins.foldl' (acc: { name, value }: acc // { ${name} = value; }) { } (
            builtins.concatLists (
              nixpkgs.lib.mapAttrsToList (
                hostname: defaultTheme:
                let
                  # Default config uses the host's default theme
                  default = {
                    name = "${user.username}@${hostname}";
                    value = mkHome hostname defaultTheme;
                  };
                  # Named variant for every theme
                  variants = nixpkgs.lib.mapAttrsToList (themeName: _: {
                    name = "${user.username}@${hostname}-${themeName}";
                    value = mkHome hostname themeName;
                  }) themes;
                in
                [ default ] ++ variants
              ) hostDefaults
            )
          );
        in
        allConfigs;
```

Note: The bare `anthony` default (currently `mkHome "tiberius"`) is removed. Use `anthony@tiberius` instead, which maps to the default theme for tiberius.

**Step 2: Verify it evaluates**

Run:

```bash
nix flake show --no-build 2>&1 | head -40
```

Expected: Should list homeConfigurations including `anthony@atlas`, `anthony@atlas-catppuccin-mocha`, `anthony@atlas-final-fantasy`, etc.

**Step 3: Commit**

```bash
git add flake.nix
git commit -m "feat: generate home configs for all host x theme combinations"
```

---

### Task 6: Clean Up Host Overrides

**Files:**

- Modify: `hosts/atlas/home-overrides.nix:28`
- Modify: `hosts/tiberius/home-overrides.nix:29`
- Modify: `hosts/lapnix/home-overrides.nix:3`

**Step 1: Remove wallpaper from atlas home-overrides**

In `hosts/atlas/home-overrides.nix`, remove line 28:

```nix
    hyprpaper.wallpaper = "${../../modules/stylix/assets/walls/FF.png}";
```

The `modules` block should become:

```nix
  modules = {
    hyprland.monitors = [
      ...
    ];
  };
```

**Step 2: Remove wallpaper from tiberius home-overrides**

In `hosts/tiberius/home-overrides.nix`, remove line 29:

```nix
    hyprpaper.wallpaper = "${../../modules/stylix/assets/walls/FF.png}";
```

**Step 3: Remove wallpaper from lapnix home-overrides**

In `hosts/lapnix/home-overrides.nix`, remove line 3:

```nix
    hyprpaper.wallpaper = "${../../modules/stylix/assets/walls/FF.png}";
```

The file should become:

```nix
{
  modules = {
    hyprland.monitors = [
      {
        name = "eDP-1";
        enabled = true;
        scale = "1.25";
      }
    ];
  };
}
```

**Step 4: Commit**

```bash
git add hosts/atlas/home-overrides.nix hosts/tiberius/home-overrides.nix hosts/lapnix/home-overrides.nix
git commit -m "refactor: remove wallpaper from host overrides (now from theme registry)"
```

---

### Task 7: Remove Defaults from Stylix Module

**Files:**

- Modify: `modules/stylix/default.nix:21-36`

**Step 1: Remove default values from theme and wallpaper options**

The `modules.themes.theme` and `modules.themes.wallpaper` options should no longer have defaults since they're now always set by the flake-level theme injection. Remove the `default` lines:

```nix
    modules.themes.theme = mkOption {
      type = types.either types.str types.path;
      description = "Path to base16 YAML theme file";
      example = ''
        ./assets/themes/grail.yaml
        $${pkgs.base16-schemes}/share/themes/material-darker.yaml
      '';
    };
    modules.themes.wallpaper = mkOption {
      type = types.path;
      description = "Path to wallpaper image";
      example = ''
        ./path/to/wallpaper.png
        ~/Wallpapers/Eric.png
      '';
    };
```

**Step 2: Commit**

```bash
git add modules/stylix/default.nix
git commit -m "refactor: remove theme/wallpaper defaults (injected from flake)"
```

---

### Task 8: Verify the Full Build

**Step 1: Check flake outputs**

```bash
nix flake show --no-build 2>&1 | grep homeConfigurations
```

Expected: Should show all host x theme combos.

**Step 2: Build the current host config**

```bash
nix build .#homeConfigurations.anthony@atlas.activationPackage --dry-run
```

Expected: Should resolve without errors.

**Step 3: Build a themed variant**

```bash
nix build .#homeConfigurations.anthony@atlas-catppuccin-mocha.activationPackage --dry-run
```

Expected: Should resolve without errors.

**Step 4: Commit (if any fixes needed)**

Only if adjustments were required.

---

### Task 9: Add Placeholder Wallpapers

The user needs to add wallpapers for the new themes. This task creates placeholder files so the build doesn't fail.

**Files:**

- Create: `modules/stylix/assets/walls/catppuccin-mocha.png`
- Create: `modules/stylix/assets/walls/tokyo-night.png`
- Create: `modules/stylix/assets/walls/hyprland-default.png`

**Step 1: Copy existing wallpapers as placeholders**

```bash
cp modules/stylix/assets/walls/FF.png modules/stylix/assets/walls/catppuccin-mocha.png
cp modules/stylix/assets/walls/Igris.png modules/stylix/assets/walls/tokyo-night.png
cp modules/stylix/assets/walls/wallpaper.png modules/stylix/assets/walls/hyprland-default.png
```

**Step 2: Commit**

```bash
git add modules/stylix/assets/walls/catppuccin-mocha.png modules/stylix/assets/walls/tokyo-night.png modules/stylix/assets/walls/hyprland-default.png
git commit -m "feat: add placeholder wallpapers for new themes (replace with real ones)"
```

---

### Task 10: Final Integration Test

**Step 1: Run nix flake check**

```bash
nix flake check 2>&1
```

Expected: No errors.

**Step 2: Test theme-switch script builds**

```bash
nix build .#homeConfigurations.anthony@atlas.activationPackage 2>&1 | tail -5
```

Expected: Builds successfully.

**Step 3: List available theme configs**

```bash
nix flake show --no-build 2>&1 | grep "anthony@"
```

Expected: Shows `anthony@atlas`, `anthony@atlas-final-fantasy`, `anthony@atlas-catppuccin-mocha`, `anthony@atlas-tokyo-night`, `anthony@atlas-gruvbox`, `anthony@atlas-dark-oxide`, `anthony@atlas-hyprland-default`, and same for other hosts.
