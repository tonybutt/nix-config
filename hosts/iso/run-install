host=$1
# This is temporary, first boot we will register a FIDO2 token as the drive decryption method.
# Disko currently doesn't support configuring crypted for a FIDO2 or TPM2 decryption this is
# this is left up to the end user.
echo -n "password" > /tmp/secret.key
cp -R /iso/cfg /tmp/cfg
nixos-generate-config --dir "/tmp/cfg/hosts/$host" --no-filesystems
disko --mode disko --flake "/tmp/cfg#$host"
nixos-install --flake "/tmp/cfg#$host" --no-channel-copy --cores 0 --no-root-password
nixos-enter -c 'passwd anthony'
# chown anthony:users "/tmp/cfg/hosts/$host/hardware-configuration.nix"
# mkdir -p /mnt/home/anthony/.dotfiles 
# rsync --chown=anthony:users /iso/cfg /mnt/home/anthony/.dotfiles